[gd_scene load_steps=2 format=3 uid="uid://dfhtv00kvuw0n"]

[sub_resource type="GDScript" id="GDScript_w5tj2"]
script/source = "extends Control

signal upgrade_chosen(upgrade)

@export var upgrade_data: Array

func _ready():
	visible = false
	process_mode = Node.PROCESS_MODE_ALWAYS
	
	# CRITICAL: Block mouse input - this is the key fix!
	mouse_filter = Control.MOUSE_FILTER_STOP
	
	# Set size to cover viewport
	custom_minimum_size = get_viewport_rect().size
	size = get_viewport_rect().size
	
	# Center it on screen (in case parent has offset)
	position = Vector2.ZERO
	
	# Make it stay in place relative to camera
	set_anchors_preset(Control.PRESET_FULL_RECT)

func show_upgrades_from_weapon_manager():
	# Get weapon manager from player
	var player = get_tree().get_first_node_in_group(\"player\")
	if not player:
		push_error(\"No player found!\")
		return
	
	var weapon_manager = player.get_node_or_null(\"WeaponManager\")
	if not weapon_manager:
		push_error(\"No WeaponManager on player!\")
		return
	
	# Get upgrade options from weapon manager
	var options = weapon_manager.get_random_upgrade_options()
	
	if options.is_empty():
		push_error(\"No upgrade options available!\")
		return
	
	# Show the menu
	visible = true
	get_tree().paused = true
	
	# Center the panel on screen
	if has_node(\"Panel\"):
		var panel = $Panel
		var viewport_size = get_viewport_rect().size
		panel.position = (viewport_size - panel.size) / 2
	
	# Setup buttons
	var buttons = $\"Panel/VBoxContainer\".get_children()
	for i in range(min(options.size(), buttons.size())):
		var button = buttons[i]
		button.text = options[i].name
		button.visible = true
		
		# Disconnect all existing connections
		for connection in button.pressed.get_connections():
			button.pressed.disconnect(connection.callable)
		
		# Connect with ONE_SHOT flag
		button.pressed.connect(_on_upgrade_pressed.bind(options[i]), CONNECT_ONE_SHOT)
	
	# Hide unused buttons if less than 3 options
	for i in range(options.size(), buttons.size()):
		buttons[i].visible = false

func _on_upgrade_pressed(selected_upgrade):
	var player = get_tree().get_first_node_in_group(\"player\")
	var weapon_manager = player.get_node(\"WeaponManager\")
	
	# Apply the upgrade
	if selected_upgrade.type == \"new_weapon\":
		weapon_manager.add_weapon(selected_upgrade.weapon)
	elif selected_upgrade.type == \"upgrade\":
		selected_upgrade.weapon.upgrade()
	
	# Emit signal for any other systems that need to know
	upgrade_chosen.emit(selected_upgrade)
	
	visible = false
	get_tree().paused = false

# Keep your old function for backward compatibility (if needed)
func show_upgrades(all_upgrades):
	visible = true
	get_tree().paused = true
	
	# Center the panel on screen
	if has_node(\"Panel\"):
		var panel = $Panel
		var viewport_size = get_viewport_rect().size
		panel.position = (viewport_size - panel.size) / 2
	
	var chosen = all_upgrades.duplicate()
	chosen.shuffle()
	var options = chosen.slice(0, 3)
	
	var buttons = $\"Panel/VBoxContainer\".get_children()
	for i in range(min(3, buttons.size())):
		var button = buttons[i]
		button.text = options[i].name
		button.visible = true
		
		# Disconnect all existing connections
		for connection in button.pressed.get_connections():
			button.pressed.disconnect(connection.callable)
		
		# Connect with ONE_SHOT flag
		button.pressed.connect(_on_upgrade_pressed_old.bind(options[i]), CONNECT_ONE_SHOT)
	
	# Hide unused buttons if less than 3 options
	#for i in range(options.size(), buttons.size()):
		#buttons[i].visible = false

func _on_upgrade_pressed_old(selected_upgrade):
	print(\"Upgrade chosen\", selected_upgrade)
	upgrade_chosen.emit(selected_upgrade)
	visible = false
	get_tree().paused = false

# Helper function to center the panel on screen
func _center_panel():
	if not has_node(\"Panel\"):
		return
	
	var panel = $Panel
	var viewport_size = get_viewport_rect().size
	
	# Center the panel
	panel.position = (viewport_size - panel.size) / 2
"

[node name="Control" type="Control"]
z_index = 44
layout_mode = 3
anchors_preset = 0
offset_right = 40.0
offset_bottom = 40.0
script = SubResource("GDScript_w5tj2")

[node name="Panel" type="Panel" parent="."]
layout_mode = 0
offset_right = 40.0
offset_bottom = 40.0

[node name="VBoxContainer" type="VBoxContainer" parent="Panel"]
layout_mode = 0
offset_right = 40.0
offset_bottom = 40.0

[node name="Button1" type="Button" parent="Panel/VBoxContainer"]
layout_mode = 2

[node name="Button2" type="Button" parent="Panel/VBoxContainer"]
layout_mode = 2

[node name="Button3" type="Button" parent="Panel/VBoxContainer"]
layout_mode = 2
